'use client';

import { useState, useEffect } from 'react';
import { 
  addLexiconEntry, 
  getAllVocabulary, 
  subscribeToVocabulary,
  deleteVocabulary,
  type VocabularyEntry 
} from '@/lib/firebase';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Textarea } from '@/components/ui/textarea';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Trash2, Plus } from 'lucide-react';
import { useToast } from '@/hooks/use-toast';

export default function FirestoreDemoPage() {
  const [vocabulary, setVocabulary] = useState<VocabularyEntry[]>([]);
  const [term, setTerm] = useState('');
  const [definition, setDefinition] = useState('');
  const [isLoading, setIsLoading] = useState(false);
  const { toast } = useToast();

  // è®¾ç½®å®æ—¶ç›‘å¬
  useEffect(() => {
    const unsubscribe = subscribeToVocabulary((updatedVocabulary) => {
      console.log('ğŸ“ è¯æ±‡åº“æ›´æ–°:', updatedVocabulary);
      setVocabulary(updatedVocabulary);
    });

    // æ¸…ç†å‡½æ•°
    return () => unsubscribe();
  }, []);

  // æ·»åŠ æ–°è¯æ±‡
  const handleAddVocabulary = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!term || !definition) return;

    setIsLoading(true);
    const result = await addLexiconEntry(term, definition, {
      category: 'Aviation',
      difficulty: 'intermediate'
    });

    if (result.success) {
      toast({
        title: 'æ·»åŠ æˆåŠŸ',
        description: `è¯æ±‡ "${term}" å·²æ·»åŠ åˆ°æ•°æ®åº“`,
        className: 'bg-green-600 text-white border-green-700'
      });
      setTerm('');
      setDefinition('');
    } else {
      toast({
        title: 'æ·»åŠ å¤±è´¥',
        description: 'è¯·æ£€æŸ¥æ‚¨çš„ç½‘ç»œè¿æ¥å’Œ Firebase é…ç½®',
        variant: 'destructive'
      });
    }
    setIsLoading(false);
  };

  // åˆ é™¤è¯æ±‡
  const handleDelete = async (id: string, termName: string) => {
    const result = await deleteVocabulary(id);
    
    if (result.success) {
      toast({
        title: 'åˆ é™¤æˆåŠŸ',
        description: `è¯æ±‡ "${termName}" å·²ä»æ•°æ®åº“åˆ é™¤`,
      });
    } else {
      toast({
        title: 'åˆ é™¤å¤±è´¥',
        description: 'è¯·ç¨åé‡è¯•',
        variant: 'destructive'
      });
    }
  };

  // æ·»åŠ ç¤ºä¾‹æ•°æ®
  const addExampleData = async () => {
    const examples = [
      {
        term: "Aerodynamics",
        definition: "The study of the properties of moving air and the interaction between the air and solid bodies moving through it.",
        category: "Physics"
      },
      {
        term: "Thrust",
        definition: "The force which moves an aircraft through the air. Thrust is generated by the propulsion system of the aircraft.",
        category: "Physics"
      },
      {
        term: "Lift",
        definition: "The force that directly opposes the weight of an airplane and holds the airplane in the air.",
        category: "Physics"
      },
      {
        term: "Drag",
        definition: "The aerodynamic force that opposes an aircraft\'s motion through the air.",
        category: "Physics"
      }
    ];

    setIsLoading(true);
    for (const example of examples) {
      await addLexiconEntry(example.term, example.definition, {
        category: example.category,
        difficulty: 'intermediate'
      });
    }
    setIsLoading(false);
    
    toast({
      title: 'ç¤ºä¾‹æ•°æ®å·²æ·»åŠ ',
      description: 'å·²æ·»åŠ 4ä¸ªèˆªç©ºæœ¯è¯­åˆ°æ•°æ®åº“',
      className: 'bg-green-600 text-white border-green-700'
    });
  };

  return (
    <div className="max-w-6xl mx-auto p-6 space-y-6">
      <h1 className="text-3xl font-bold text-white mb-8">Firestore å®æ—¶æ•°æ®æ¼”ç¤º</h1>
      
      {/* æ·»åŠ è¯æ±‡è¡¨å• */}
      <Card className="glass-card">
        <CardHeader>
          <CardTitle>æ·»åŠ æ–°è¯æ±‡</CardTitle>
        </CardHeader>
        <CardContent>
          <form onSubmit={handleAddVocabulary} className="space-y-4">
            <div>
              <Input
                placeholder="æœ¯è¯­ (å¦‚: Altitude)"
                value={term}
                onChange={(e) => setTerm(e.target.value)}
                className="glass-card"
                required
              />
            </div>
            <div>
              <Textarea
                placeholder="å®šä¹‰ (å¦‚: The height of an aircraft above a reference point...)"
                value={definition}
                onChange={(e) => setDefinition(e.target.value)}
                className="glass-card"
                rows={3}
                required
              />
            </div>
            <div className="flex gap-2">
              <Button 
                type="submit" 
                disabled={isLoading || !term || !definition}
                className="gradient-primary"
              >
                <Plus className="h-4 w-4 mr-2" />
                æ·»åŠ è¯æ±‡
              </Button>
              <Button 
                type="button"
                onClick={addExampleData}
                disabled={isLoading}
                variant="outline"
                className="glass-card"
              >
                æ·»åŠ ç¤ºä¾‹æ•°æ®
              </Button>
            </div>
          </form>
        </CardContent>
      </Card>

      {/* è¯æ±‡åˆ—è¡¨ */}
      <Card className="glass-card">
        <CardHeader>
          <CardTitle>
            è¯æ±‡åº“ ({vocabulary.length} ä¸ªè¯æ±‡)
            <span className="text-sm font-normal text-gray-400 ml-2">
              å®æ—¶åŒæ­¥æ›´æ–°
            </span>
          </CardTitle>
        </CardHeader>
        <CardContent>
          {vocabulary.length === 0 ? (
            <p className="text-gray-400 text-center py-8">
              æš‚æ— è¯æ±‡ã€‚æ·»åŠ æ‚¨çš„ç¬¬ä¸€ä¸ªèˆªç©ºæœ¯è¯­å§ï¼
            </p>
          ) : (
            <div className="space-y-3">
              {vocabulary.map((entry) => (
                <div 
                  key={entry.id}
                  className="glass-card rounded-lg p-4 hover:bg-white/10 transition-colors"
                >
                  <div className="flex justify-between items-start">
                    <div className="flex-1">
                      <h3 className="font-semibold text-white mb-1">{entry.term}</h3>
                      <p className="text-sm text-gray-300">{entry.definition}</p>
                      {entry.category && (
                        <span className="inline-block mt-2 px-2 py-1 bg-purple-500/20 text-purple-300 text-xs rounded">
                          {entry.category}
                        </span>
                      )}
                    </div>
                    <Button
                      size="icon"
                      variant="ghost"
                      onClick={() => handleDelete(entry.id!, entry.term)}
                      className="text-gray-400 hover:text-red-400 ml-4"
                    >
                      <Trash2 className="h-4 w-4" />
                    </Button>
                  </div>
                </div>
              ))}
            </div>
          )}
        </CardContent>
      </Card>

      {/* è¯´æ˜ */}
      <Card className="glass-card border-blue-500/30">
        <CardHeader>
          <CardTitle className="text-blue-300">ğŸ”¥ Firestore å®æ—¶åŠŸèƒ½æ¼”ç¤º</CardTitle>
        </CardHeader>
        <CardContent className="text-sm text-gray-300 space-y-2">
          <p>
            è¿™ä¸ªé¡µé¢å±•ç¤ºäº† Firestore çš„å®æ—¶åŒæ­¥åŠŸèƒ½ã€‚å½“æ‚¨æ·»åŠ ã€ä¿®æ”¹æˆ–åˆ é™¤è¯æ±‡æ—¶ï¼Œ
            æ‰€æœ‰æ‰“å¼€è¿™ä¸ªé¡µé¢çš„ç”¨æˆ·éƒ½ä¼šç«‹å³çœ‹åˆ°æ›´æ–°ï¼Œæ— éœ€åˆ·æ–°é¡µé¢ï¼
          </p>
          <p>
            è¯•è¯•åœ¨ä¸¤ä¸ªæµè§ˆå™¨çª—å£ä¸­æ‰“å¼€è¿™ä¸ªé¡µé¢ï¼Œç„¶ååœ¨å…¶ä¸­ä¸€ä¸ªçª—å£æ·»åŠ è¯æ±‡ï¼Œ
            æ‚¨ä¼šçœ‹åˆ°å¦ä¸€ä¸ªçª—å£ç«‹å³æ˜¾ç¤ºæ–°è¯æ±‡ã€‚
          </p>
          <p className="text-yellow-400">
            æ³¨æ„ï¼šéœ€è¦é…ç½®çœŸå®çš„ Firebase é¡¹ç›®æ‰èƒ½ä½¿ç”¨è¿™äº›åŠŸèƒ½ã€‚
          </p>
        </CardContent>
      </Card>
    </div>
  );
} 