# 大文档处理完整指南

## ⚠️ 重要更新：文件格式支持

**当前版本仅支持纯文本文件(.txt)**

由于PDF和Word文档的二进制内容会导致严重的乱码问题，系统已暂时禁用对这些格式的直接支持。

### 如何处理PDF和Word文档

#### 方法1：复制粘贴（推荐）
1. 打开PDF或Word文档
2. 选择并复制所需内容
3. 粘贴到文本编辑器（如记事本、Notepad++）
4. 保存为.txt文件
5. 上传到系统

#### 方法2：另存为文本
1. 在Word中：文件 → 另存为 → 选择"纯文本(.txt)"格式
2. 在PDF阅读器中：文件 → 另存为 → 选择"文本文件"格式

#### 方法3：使用在线转换工具
- PDF转文本：使用PDF.io、SmallPDF等在线工具
- Word转文本：直接在Word中另存为文本格式

### 清理现有乱码数据

如果您之前上传了PDF或Word文件导致产生乱码条目：

1. **使用清理功能**：在知识库页面点击"清理乱码"按钮
2. **系统自动检测**：会识别包含二进制数据、PDF标记或大量特殊字符的条目
3. **批量删除**：确认后系统会自动删除所有检测到的乱码条目

清理功能会检测以下乱码特征：
- 包含PDF格式标记（如`endstream`、`endobj`、`xref`等）
- 包含大量控制字符或二进制数据
- 标题中特殊字符比例超过30%

## 概述

Lexicon AI助手现已配备完整的大文档处理和AI配额管理系统，可以稳定处理从小文档到超大文档的各种内容，并提供AI和手动两种处理模式。

## AI配额管理系统

### 自动配额检查
系统会自动检查AI服务的配额状态：
- **可用状态**：显示AI服务正常运行，会显示累计失败次数
- **不可用状态**：显示具体原因、预计恢复时间和失败次数
- **自动暂停**：连续失败15次后自动暂停AI服务2小时

### 处理模式选择

#### AI模式优势
- 智能内容分析
- 高质量知识提取
- 自动分类标记
- 关键词智能识别

#### 手动模式优势  
- 即时处理完成
- 无需等待配额
- 基于文档结构
- 稳定可靠

#### 模式自动切换
- AI服务不可用时自动启用手动模式
- 用户可手动选择使用哪种模式
- AI配额耗尽时强制使用手动模式

## 智能分块处理系统

### 当前配置参数（超保守策略）
- **分块触发阈值**：30万tokens（约120万字符）
- **单块大小限制**：20万tokens（约80万字符）  
- **全局请求间隔**：15秒
- **重试次数**：6次
- **基础延迟**：30秒（指数退避）
- **冷却期机制**：连续失败3次后额外等待60秒

### 分块算法特点
1. **按行分割**：保持内容完整性，避免截断句子
2. **超长行处理**：自动分割超长行，按词汇边界切分
3. **实时验证**：每个块创建后立即验证大小
4. **智能截断**：对超长词汇进行强制截断保护

### 文档大小分类

#### 小文档 (< 30万tokens, < 1.2MB)
- **处理方式**：单次AI调用
- **AI模式时间**：30-90秒
- **手动模式时间**：即时完成
- **推荐**：优先使用AI模式

#### 中文档 (30万-100万tokens, 1.2-4MB)  
- **处理方式**：分3-5块处理
- **AI模式时间**：10-30分钟
- **手动模式时间**：即时完成
- **推荐**：根据AI配额状态选择

#### 大文档 (100万-500万tokens, 4-20MB)
- **处理方式**：分5-25块处理  
- **AI模式时间**：30-90分钟
- **手动模式时间**：即时完成
- **推荐**：优先使用手动模式

#### 超大文档 (> 500万tokens, > 20MB)
- **处理方式**：分25+块处理
- **AI模式时间**：2-6小时
- **手动模式时间**：即时完成  
- **推荐**：强烈建议使用手动模式

## 重试和错误处理机制

### 指数退避策略
重试延迟时间：30秒 → 60秒 → 120秒 → 240秒 → 480秒 → 960秒

### 智能错误识别
- **429错误**：API配额限制，触发重试机制
- **Token超限**：自动分块处理
- **网络错误**：短暂重试后提示用户
- **服务不可用**：自动切换到手动模式

### 连续失败保护
- **3次失败**：启动冷却期（60秒）
- **10次失败**：强烈建议手动模式
- **15次失败**：自动暂停AI服务2小时

## 手动模式算法详解

### 文档结构识别
1. **标题检测**：
   - Markdown标题（#开头）
   - 数字序号（1. 2. 3.）
   - 章节关键词（第、章节、部分等）
   - 全大写短文本
   
2. **内容分割**：
   - 按检测到的标题分割章节
   - 每章节生成独立知识条目
   - 自动截断过长内容（500字符）

3. **智能分类**：
   - 部门信息：包含"部门"、"组织"、"机构"
   - 岗位职责：包含"职责"、"岗位"、"职位"  
   - 工作流程：包含"流程"、"步骤"、"程序"
   - 规章制度：包含"规定"、"制度"、"规章"
   - 默认分类：专业术语

4. **关键词提取**：
   - 移除标点符号
   - 词频统计
   - 提取前5个高频词作为关键词

## 用户界面指南

### 状态显示系统
- **实时进度条**：显示处理进度百分比
- **详细状态文字**：具体说明当前操作
- **时间预估**：根据文档大小和模式预估时间
- **错误提示**：详细的错误信息和解决建议

### 文档信息展示
- **文件名和大小**
- **预估Token数量**
- **预估处理时间**
- **模式选择提示**

### 大文档警告
系统会对超过100万tokens的文档显示警告，建议：
- 拆分成较小文档分批上传
- 使用手动模式快速处理
- 处理过程中保持页面开启

## 最佳实践建议

### AI模式使用建议
1. **小文档优先**：< 30万tokens时首选AI模式
2. **配额监控**：定期检查配额状态
3. **错误处理**：遇到429错误时耐心等待
4. **分批处理**：大量文档分时段上传

### 手动模式使用建议  
1. **结构化文档**：有清晰标题层次的文档效果最佳
2. **预处理优化**：上传前整理文档格式
3. **批量处理**：手动模式适合处理大量文档
4. **后期编辑**：可在知识库中手动调整提取结果

### 混合策略
1. **先试AI模式**：如果配额充足，先尝试AI处理
2. **遇阻切换**：遇到429错误立即切换手动模式
3. **质量对比**：比较两种模式的提取质量
4. **效率优先**：时间紧急时直接使用手动模式

## 故障排除

### 常见问题及解决方案

#### 429错误频繁出现
**原因**：API配额不足或使用频率过高
**解决**：
- 等待配额恢复（通常24小时重置）
- 切换到手动模式继续工作
- 检查Google Cloud控制台配额设置

#### 处理时间过长
**原因**：文档过大或网络延迟
**解决**：
- 使用手动模式快速处理
- 分割文档成较小文件
- 检查网络连接稳定性

#### 提取质量不理想
**原因**：文档格式不规范或内容复杂
**解决**：
- AI模式：调整文档格式重新上传
- 手动模式：优化文档标题结构
- 后期手动编辑知识条目

#### AI服务暂停
**原因**：连续失败次数过多
**解决**：
- 等待自动恢复（2小时后）
- 使用手动模式继续工作
- 检查网络和配额状态

## 技术参数总结

### 超保守处理参数
- 分块大小：20万tokens
- 分块触发：30万tokens  
- 请求间隔：15秒
- 重试次数：6次
- 基础延迟：30秒
- 冷却期：60秒
- 暂停阈值：15次连续失败

### 性能数据
| 文档大小 | AI模式时间 | 手动模式时间 | 推荐模式 |
|---------|-----------|-------------|---------|
| < 300KB | 30-90秒 | 即时 | AI优先 |
| 0.3-1MB | 10-30分钟 | 即时 | 根据配额 |
| 1-5MB | 30-90分钟 | 即时 | 手动优先 |
| 5-20MB | 2-6小时 | 即时 | 强烈建议手动 |

这个系统的设计理念是**稳定性优于速度**，确保即使在最严苛的API限制下也能为用户提供可靠的文档处理服务。 