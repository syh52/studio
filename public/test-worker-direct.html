<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç›´æ¥Workeræµ‹è¯•</title>
    <style>
        body { font-family: Arial; margin: 40px; }
        .test { margin: 20px 0; padding: 20px; background: #f0f0f0; border-radius: 5px; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        pre { background: #333; color: #0f0; padding: 15px; overflow-x: auto; }
        .success { color: green; }
        .error { color: red; }
    </style>
</head>
<body>
    <h1>ğŸ” ç›´æ¥Workeræµ‹è¯•</h1>
    <p>æµ‹è¯•ç›´æ¥è®¿é—®Cloudflare Worker URLï¼Œç»•è¿‡è‡ªå®šä¹‰åŸŸå</p>
    
    <div class="test">
        <h3>Workeråˆ—è¡¨</h3>
        <p>æ‚¨çš„Worker URLåº”è¯¥ç±»ä¼¼ï¼šhttps://lexicon-cn-proxy.æ‚¨çš„ç”¨æˆ·å.workers.dev</p>
        <input type="text" id="workerUrl" placeholder="è¾“å…¥æ‚¨çš„Worker URL" style="width: 400px; padding: 5px;">
        <button onclick="saveWorkerUrl()">ä¿å­˜</button>
    </div>
    
    <div class="test">
        <button onclick="testWorkerStatus()">æµ‹è¯•WorkerçŠ¶æ€</button>
        <button onclick="testWebChannel()">æµ‹è¯•WebChannel</button>
        <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
        <pre id="log"></pre>
    </div>

    <script>
    const log = document.getElementById('log');
    const workerUrlInput = document.getElementById('workerUrl');
    
    // ä»localStorageåŠ è½½ä¿å­˜çš„URL
    const savedUrl = localStorage.getItem('workerUrl');
    if (savedUrl) {
        workerUrlInput.value = savedUrl;
    }
    
    function saveWorkerUrl() {
        const url = workerUrlInput.value.trim();
        if (url) {
            localStorage.setItem('workerUrl', url);
            addLog('âœ… Worker URLå·²ä¿å­˜', 'success');
        }
    }
    
    function addLog(message, type = '') {
        const timestamp = new Date().toLocaleTimeString();
        const className = type ? ` class="${type}"` : '';
        log.innerHTML += `<span${className}>[${timestamp}] ${message}</span>\n`;
        log.scrollTop = log.scrollHeight;
    }
    
    function clearLog() {
        log.innerHTML = '';
    }
    
    async function testWorkerStatus() {
        const workerUrl = workerUrlInput.value.trim();
        if (!workerUrl) {
            addLog('âŒ è¯·å…ˆè¾“å…¥Worker URL', 'error');
            return;
        }
        
        addLog('æµ‹è¯•WorkerçŠ¶æ€...');
        
        try {
            // æµ‹è¯•Workeræ ¹è·¯å¾„
            const response = await fetch(workerUrl, {
                mode: 'cors',
                credentials: 'include'
            });
            
            addLog(`å“åº”çŠ¶æ€: ${response.status}`);
            
            if (response.ok) {
                const data = await response.json();
                addLog('Workerä¿¡æ¯:', 'success');
                addLog(JSON.stringify(data, null, 2));
            } else {
                const text = await response.text();
                addLog(`é”™è¯¯å“åº”: ${text}`, 'error');
            }
            
        } catch (error) {
            addLog(`âŒ é”™è¯¯: ${error.message}`, 'error');
        }
    }
    
    async function testWebChannel() {
        const workerUrl = workerUrlInput.value.trim();
        if (!workerUrl) {
            addLog('âŒ è¯·å…ˆè¾“å…¥Worker URL', 'error');
            return;
        }
        
        addLog('æµ‹è¯•WebChannelè¿æ¥...');
        
        const params = new URLSearchParams({
            VER: '8',
            database: 'projects/aviation-lexicon-trainer/databases/(default)',
            RID: '88546',
            CVER: '22',
            'X-HTTP-Session-Id': 'gsessionid',
            zx: 'test' + Date.now(),
            t: '1'
        });
        
        const testUrl = `${workerUrl}/firestore.googleapis.com/google.firestore.v1.Firestore/Listen/channel?${params}`;
        
        try {
            addLog(`è¯·æ±‚URL: ${testUrl}`);
            
            const response = await fetch(testUrl, {
                method: 'GET',
                mode: 'cors',
                credentials: 'include',
                headers: {
                    'Accept': '*/*',
                    'Cache-Control': 'no-cache'
                }
            });
            
            addLog(`å“åº”çŠ¶æ€: ${response.status} ${response.statusText}`);
            
            // æ˜¾ç¤ºå“åº”å¤´
            const headers = {};
            response.headers.forEach((value, key) => {
                headers[key] = value;
            });
            addLog('å“åº”å¤´:');
            addLog(JSON.stringify(headers, null, 2));
            
            // æ£€æŸ¥CORS
            const corsOrigin = response.headers.get('access-control-allow-origin');
            const corsCredentials = response.headers.get('access-control-allow-credentials');
            
            if (corsOrigin && corsCredentials === 'true') {
                addLog(`âœ… CORSæ­£ç¡®è®¾ç½®: Origin=${corsOrigin}, Credentials=${corsCredentials}`, 'success');
            } else {
                addLog(`âŒ CORSé”™è¯¯: Origin=${corsOrigin}, Credentials=${corsCredentials}`, 'error');
            }
            
            // å¦‚æœæ˜¯é”™è¯¯å“åº”ï¼Œè¯»å–å†…å®¹
            if (!response.ok) {
                const text = await response.text();
                addLog('å“åº”å†…å®¹:');
                addLog(text.substring(0, 500) + (text.length > 500 ? '...' : ''));
            }
            
        } catch (error) {
            addLog(`âŒ è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
            addLog(error.stack);
        }
    }
    
    // é¡µé¢åŠ è½½æ—¶çš„æç¤º
    window.addEventListener('load', () => {
        addLog('è¯·è¾“å…¥æ‚¨çš„Cloudflare Worker URLï¼Œä¾‹å¦‚ï¼š');
        addLog('https://lexicon-cn-proxy.æ‚¨çš„ç”¨æˆ·å.workers.dev');
        addLog('å¯ä»¥åœ¨Cloudflare Dashboardçš„Workers & Pagesä¸­æ‰¾åˆ°');
    });
    </script>
</body>
</html> 